# SPDX-FileCopyrightText: 2025 Jon Thor Kristinsson
# SPDX-License-Identifier: Apache-2.0

name: Performance Validation

on:
  schedule:
    - cron: '0 4 * * *'  # 4 AM UTC daily (off-peak)
  workflow_dispatch:
    inputs:
      threshold:
        description: 'Regression threshold percentage'
        default: '10'
        type: string

permissions:
  contents: read

env:
  GO_VERSION_STABLE: '1.23'

jobs:
  performance-validation:
    name: Performance Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Go
        uses: actions/setup-go@3041bf56c941b39c61721a86cd11f3bb1338122a # v5.2.0
        with:
          go-version: ${{ env.GO_VERSION_STABLE }}
          cache: true

      - name: Install benchstat
        run: go install golang.org/x/perf/cmd/benchstat@v0.0.0-20241210162007-16b3e5c6f68b

      - name: Install oapi-codegen
        run: go install github.com/oapi-codegen/oapi-codegen/v2/cmd/oapi-codegen@latest

      - name: Generate mock builders
        run: make generate-mocks

      - name: Run benchmarks (multiple iterations)
        run: |
          go test -bench=. -benchmem -count=10 -run=^$ ./tests/benchmarks/... 2>&1 | tee benchmark-current.txt

      - name: Compare and check for regressions
        run: |
          if [ -f benchmarks/baseline.txt ]; then
            benchstat -delta-test=utest benchmarks/baseline.txt benchmark-current.txt > comparison.txt
            cat comparison.txt

            # Check for significant regressions (>10% slower)
            if grep -E '\+[0-9]{2,}\.[0-9]+%' comparison.txt; then
              echo "::warning::Significant performance regression detected"
            fi
          else
            echo "No baseline found - cannot compare performance"
          fi

      - name: Upload results
        uses: actions/upload-artifact@47309c993abb98030a35d55ef7ff34b7fa1074b5 # v4.5.0
        with:
          name: performance-validation-${{ github.run_number }}
          path: |
            benchmark-current.txt
            comparison.txt

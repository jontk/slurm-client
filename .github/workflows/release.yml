# SPDX-FileCopyrightText: 2025 Jon Thor Kristinsson
# SPDX-License-Identifier: Apache-2.0

name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to release'
        required: true
        type: string

permissions:
  contents: write
  packages: write
  id-token: write  # Required for cosign keyless signing

jobs:
  validate-tag:
    name: Validate Tag
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      prerelease: ${{ steps.check_prerelease.outputs.prerelease }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: Get version from tag
      id: get_version
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.tag }}"
        else
          VERSION="${GITHUB_REF#refs/tags/}"
        fi
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "Version: ${VERSION}"

    - name: Validate version format
      run: |
        VERSION="${{ steps.get_version.outputs.version }}"
        if ! echo "$VERSION" | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+)?$'; then
          echo "Invalid version format: $VERSION"
          echo "Expected format: vX.Y.Z or vX.Y.Z-suffix"
          exit 1
        fi

    - name: Check if prerelease
      id: check_prerelease
      run: |
        VERSION="${{ steps.get_version.outputs.version }}"
        if echo "$VERSION" | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+-'; then
          echo "prerelease=true" >> $GITHUB_OUTPUT
        else
          echo "prerelease=false" >> $GITHUB_OUTPUT
        fi

  test-release:
    name: Test Release Build
    needs: validate-tag
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up Go
      uses: actions/setup-go@v6
      with:
        go-version-file: 'go.mod'
        cache: true

    - name: Generate mock builders
      run: make generate-mocks

    - name: Run tests
      run: go test -v -race ./...

    - name: Build
      run: go build -v ./...

  goreleaser:
    name: Release with GoReleaser
    needs: [validate-tag, test-release]
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: Set up Go
      uses: actions/setup-go@v6
      with:
        go-version-file: 'go.mod'
        cache: true

    - name: Install cosign
      uses: sigstore/cosign-installer@v3
      with:
        cosign-release: 'v2.4.1'

    - name: Install syft
      uses: anchore/sbom-action/download-syft@v0
      with:
        syft-version: 'v1.0.1'

    - name: Run GoReleaser
      uses: goreleaser/goreleaser-action@v6
      with:
        distribution: goreleaser
        version: '~> v2'
        args: release --clean
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # publish-pkg-go-dev:
  #   name: Publish to pkg.go.dev
  #   needs: create-release
  #   runs-on: ubuntu-latest
    
  #   steps:
  #   - name: Checkout code
  #     uses: actions/checkout@v6

  #   - name: Set up Go
  #     uses: actions/setup-go@v6
  #     with:
  #       go-version-file: 'go.mod'
  #       cache: true

  #   - name: Trigger pkg.go.dev indexing
  #     run: |
  #       # pkg.go.dev will automatically index the module when we access it
  #       MODULE_PATH=$(go list -m)
  #       VERSION="${{ needs.validate-tag.outputs.version }}"
  #       curl -s "https://pkg.go.dev/${MODULE_PATH}@${VERSION}" > /dev/null || true
  #       echo "Triggered indexing for ${MODULE_PATH}@${VERSION}"

  update-documentation:
    name: Update Documentation
    needs: [validate-tag, goreleaser]
    runs-on: ubuntu-latest
    if: needs.validate-tag.outputs.prerelease == 'false'

    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        ref: main
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Update version references
      run: |
        VERSION="${{ needs.validate-tag.outputs.version }}"
        VERSION_NO_V="${VERSION#v}"
        
        # Update version in documentation
        find . -name "*.md" -type f -exec sed -i "s/slurm-client@v[0-9]\+\.[0-9]\+\.[0-9]\+/slurm-client@${VERSION}/g" {} \;
        
        # Update installation instructions
        if [ -f "README.md" ]; then
          sed -i "s|go get github.com/jontk/slurm-client@v[0-9]\+\.[0-9]\+\.[0-9]\+|go get github.com/jontk/slurm-client@${VERSION}|g" README.md
        fi

    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v5
      with:
        commit-message: "docs: update version to ${{ needs.validate-tag.outputs.version }}"
        title: "docs: update documentation for ${{ needs.validate-tag.outputs.version }}"
        body: |
          This PR updates the documentation to reference the latest release version.
          
          - Updated version references to ${{ needs.validate-tag.outputs.version }}
          - Updated installation instructions
          
          This is an automated PR created by the release workflow.
        branch: update-docs-${{ needs.validate-tag.outputs.version }}
        delete-branch: true
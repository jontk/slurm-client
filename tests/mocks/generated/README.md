# Generated Mock Builders

This directory contains **auto-generated** mock builders for SLURM API types.

## ⚠️ DO NOT EDIT

All files in this directory are generated by `tools/codegen/generate_mocks.go` from the OpenAPI specifications. Manual edits will be overwritten.

## Overview

These builders provide type-safe, fluent interfaces for creating mock SLURM API objects in tests. They guarantee:

- **Correct field names** (memory_per_node not memory)
- **Proper NoVal wrapper types** (with Set/Number/Infinite fields)
- **Correct array types** (job_state as []string)
- **Compile-time safety** - impossible to have field mismatches

## Usage

### Basic Example

```go
import builder "github.com/jontk/slurm-client/tests/mocks/generated/v0_0_40"

// Create a job with fluent builder
job := builder.NewJobInfo().
    WithJobId(1001).
    WithName("test-job").
    WithUserId(1000).
    WithJobState("RUNNING").
    WithCpus(4).
    WithMemoryPerNode(4 * 1024 * 1024 * 1024).
    WithPartition("compute").
    WithSubmitTime(time.Now().Unix()).
    Build()

// Use in mock server
mockServer.storage.Jobs["1001"] = job
```

### Available Builders

Each API version has three main builders:

- `NewJobInfo()` - For V00XXJobInfo
- `NewNode()` - For V00XXNode
- `NewPartitionInfo()` - For V00XXPartitionInfo

### How NoVal Wrapping Works

Fields like `cpus` and `memory_per_node` use special NoVal wrapper types in the SLURM API:

```json
{
  "cpus": {
    "set": true,
    "number": 4
  }
}
```

The generated builders handle this automatically:

```go
job.WithCpus(4)  // Automatically wraps as V0040Uint32NoVal{Set: true, Number: 4}
```

### How Array Fields Work

Fields like `job_state` are arrays in the API:

```json
{
  "job_state": ["RUNNING"]
}
```

The generated builders handle this automatically:

```go
job.WithJobState("RUNNING")  // Automatically wraps as &[]string{"RUNNING"}
```

## Regenerating

To regenerate all mock builders:

```bash
make generate-mocks
```

To generate for a specific version:

```bash
go run tools/codegen/generate_mocks.go v0.0.40
```

## Version Support

### Current Status

| Version | Status | Builder Methods | Essential Fields | Notes |
|---------|--------|----------------|------------------|-------|
| v0.0.40 | ✅ Complete | 126 | All present | Reference implementation |
| v0.0.41 | ❌ Unsupported | N/A | N/A | Inline schemas not supported |
| v0.0.42 | ✅ Complete | 123 | All present | NoVal detection fixed (2026-01-19) |
| v0.0.43 | ✅ Complete | 128 | All present | NoVal detection fixed (2026-01-19) |
| v0.0.44 | ✅ Complete | 129 | All present | NoVal detection fixed (2026-01-19) |

### Essential Fields Verification

All supported versions now include these critical fields:
- ✅ `job_id` - Job identifier
- ✅ `name` - Job name
- ✅ `user_id` - User ID
- ✅ `cpus` - CPU count (NoVal wrapped)
- ✅ `memory_per_node` - Memory per node (NoVal wrapped)
- ✅ `submit_time` - Submission timestamp (NoVal wrapped)
- ✅ `time_limit` - Time limit (NoVal wrapped)
- ✅ `job_state` - Job state array
- ✅ `partition` - Partition name

### Version-Specific Notes

**v0.0.40:**
- Uses `_no_val` suffix for NoVal types
- Example: `V0040Uint32NoVal`, `V0040Uint64NoVal`

**v0.0.42+:**
- Uses `_no_val_struct` suffix for NoVal types
- Example: `V0042Uint32NoValStruct`, `V0042Uint64NoValStruct`
- Includes additional `infinite` field in NoVal types

**v0.0.43:**
- Additional enum array fields (e.g., `flags`)
- oapi-codegen generates type aliases for these (e.g., `V0043JobInfoFlags`)

**v0.0.44:**
- Minor refinements and additional optional fields
- Maintains backward compatibility with v0.0.43

### Migration Between Versions

When migrating tests between versions:

1. **Update imports:**
   ```go
   // Before
   import builderv0040 "github.com/jontk/slurm-client/tests/mocks/generated/v0_0_40"

   // After
   import builderv0043 "github.com/jontk/slurm-client/tests/mocks/generated/v0_0_43"
   ```

2. **Update builder calls:**
   ```go
   // Before
   job := builderv0040.NewJobInfo().WithCpus(4).Build()

   // After
   job := builderv0043.NewJobInfo().WithCpus(4).Build()
   ```

3. **No other changes needed** - builder interface is consistent across versions

### Support Policy

See [main README](../../../README.md#supported-versions) for version support tiers:
- **Supported:** v0.0.42, v0.0.43, v0.0.44 (full test coverage, regular updates)
- **Best-effort:** v0.0.40, v0.0.41 (minimal maintenance)

For migration assistance between versions, see [MIGRATION.md](../../../MIGRATION.md).

## Architecture

### Generated Code Structure

```
tests/mocks/generated/
└── v0_0_40/
    ├── jobinfo_factory.go      # JobInfoBuilder
    ├── node_factory.go          # NodeBuilder
    └── partitioninfo_factory.go # PartitionInfoBuilder
```

### Builder Pattern

Each builder:
1. Wraps the actual OpenAPI type
2. Provides `With*()` methods for each field
3. Returns `*Builder` for fluent chaining
4. Has `Build()` to get the final object

Example generated code:

```go
type JobInfoBuilder struct {
    obj *v0_0_40.V0040JobInfo
}

func NewJobInfo() *JobInfoBuilder {
    return &JobInfoBuilder{
        obj: &v0_0_40.V0040JobInfo{},
    }
}

func (b *JobInfoBuilder) WithCpus(value int64) *JobInfoBuilder {
    setTrue := true
    b.obj.Cpus = &v0_0_40.V0040Uint32NoVal{
        Set:    &setTrue,
        Number: &value,
    }
    return b
}

func (b *JobInfoBuilder) Build() *v0_0_40.V0040JobInfo {
    return b.obj
}
```

## Benefits Over Manual Conversion

| Aspect | Manual MockJob + Convert | Generated Builders |
|--------|-------------------------|-------------------|
| Field names | ❌ Runtime errors | ✅ Compile-time guarantee |
| NoVal wrappers | ❌ Easy to forget | ✅ Automatic |
| Array fields | ❌ Type mismatches | ✅ Type-safe |
| Version differences | ❌ One type for all | ✅ Per-version types |
| Spec changes | ❌ Manual updates | ✅ Run `make generate-mocks` |

## Extending

To add support for more model types, edit `tools/codegen/generate_mocks.go`:

```go
func shouldGenerateModel(schemaName, version string) bool {
    exactMatches := []string{
        fmt.Sprintf("%s_job_info", version),
        fmt.Sprintf("%s_node", version),
        fmt.Sprintf("%s_partition_info", version),
        fmt.Sprintf("%s_reservation", version),  // Add new type
    }
    // ...
}
```

## Known Limitations

1. **Complex nested structs** - Inline object types are skipped
2. **Some ref types** - Complex referenced types (exit_code, job_resources) are skipped
3. **Array of enums** - v0.0.42/43 have some unsupported array types (being worked on)

These limitations don't affect core functionality - all essential fields (job_id, name, cpus, memory, state) work correctly.

## Migration Guide

### Before (Manual Conversion)

```go
// Manual MockJob struct
type MockJob struct {
    JobID   int32
    CPUs    int
    Memory  int64
    State   string
}

// Manual conversion with bugs waiting to happen
func convertMockJobToAPI(job *MockJob) map[string]interface{} {
    return map[string]interface{}{
        "job_id": job.JobID,
        "cpus": map[string]interface{}{  // Easy to get wrong
            "set": true,
            "number": job.CPUs,  // Forgot pointer!
        },
        "memory": job.Memory,  // Wrong field name!
        "state": job.State,    // Wrong type (should be array)!
    }
}
```

### After (Generated Builders)

```go
import builder "github.com/jontk/slurm-client/tests/mocks/generated/v0_0_40"

// Use real OpenAPI type + generated builder
job := builder.NewJobInfo().
    WithJobId(1001).
    WithCpus(4).                    // ✅ Correct wrapping
    WithMemoryPerNode(4*GB).        // ✅ Correct field name
    WithJobState("RUNNING").        // ✅ Correct array wrapping
    Build()

// No conversion needed - it's already the right type!
mockServer.storage.Jobs["1001"] = job
```

## Questions?

See:
- `tools/codegen/generate_mocks.go` - Generation logic
- `Makefile` - Build targets
- OpenAPI specs in `openapi-specs/` - Source schemas
